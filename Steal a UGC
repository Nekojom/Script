-- ================= SERVICES =================
local Players = game:GetService("Players")
local UIS = game:GetService("UserInputService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local lp = Players.LocalPlayer

-- ================= REMOVE OLD UI =================
pcall(function()
    local old = lp.PlayerGui:FindFirstChild("NekojomRandomUI")
    if old then old:Destroy() end
end)

-- ================= GUI =================
local gui = Instance.new("ScreenGui")
gui.Name = "NekojomRandomUI"
gui.ResetOnSpawn = false
gui.Parent = lp.PlayerGui

local FULL_SIZE = UDim2.fromOffset(240, 230)
local MIN_SIZE  = UDim2.fromOffset(240, 36)

local main = Instance.new("Frame")
main.Size = FULL_SIZE
main.Position = UDim2.fromScale(0.5,0.5)
main.AnchorPoint = Vector2.new(0.5,0.5)
main.BackgroundColor3 = Color3.fromRGB(20,20,25)
main.Parent = gui
Instance.new("UICorner", main).CornerRadius = UDim.new(0,16)

local stroke = Instance.new("UIStroke", main)
stroke.Color = Color3.fromRGB(180,120,255)
stroke.Thickness = 2

-- ================= TITLE BAR =================
local titleBar = Instance.new("Frame")
titleBar.Size = UDim2.new(1,0,0,36)
titleBar.BackgroundTransparency = 1
titleBar.Parent = main

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1,-60,1,0)
title.Position = UDim2.fromOffset(10,0)
title.BackgroundTransparency = 1
title.Text = "üê± Nekojom UI"
title.Font = Enum.Font.GothamBold
title.TextSize = 15
title.TextXAlignment = Enum.TextXAlignment.Left
title.TextColor3 = Color3.fromRGB(230,200,255)
title.Parent = titleBar

local minBtn = Instance.new("TextButton")
minBtn.Size = UDim2.fromOffset(28,28)
minBtn.Position = UDim2.fromOffset(200,4)
minBtn.Text = "‚Äì"
minBtn.Font = Enum.Font.GothamBold
minBtn.TextSize = 20
minBtn.BackgroundColor3 = Color3.fromRGB(60,60,80)
minBtn.TextColor3 = Color3.fromRGB(255,255,255)
minBtn.Parent = titleBar
Instance.new("UICorner", minBtn).CornerRadius = UDim.new(1,0)

-- ================= CONTENT =================
local content = Instance.new("Frame")
content.Size = UDim2.new(1,0,1,-36)
content.Position = UDim2.fromOffset(0,36)
content.BackgroundTransparency = 1
content.Visible = true
content.Parent = main

-- ================= BUTTON MAKER =================
local function makeButton(text, y)
    local b = Instance.new("TextButton")
    b.Size = UDim2.new(1,-40,0,36)
    b.Position = UDim2.fromOffset(20,y)
    b.BackgroundColor3 = Color3.fromRGB(45,45,60)
    b.Text = text
    b.Font = Enum.Font.GothamMedium
    b.TextSize = 13
    b.TextColor3 = Color3.fromRGB(240,240,240)
    b.Parent = content
    Instance.new("UICorner", b).CornerRadius = UDim.new(0,12)
    return b
end

local instantBtn   = makeButton("Instant Touch", 10)
local autoTouchBtn = makeButton("Auto Touch : OFF", 55)
local luckyBtn     = makeButton("Auto Lucky Block : OFF", 100)

-- ================= FUNCTION LOGIC =================
local function runTouch()
    local char = lp.Character or lp.CharacterAdded:Wait()
    for _, v in ipairs(workspace:GetDescendants()) do
        if v:IsA("BasePart") and v:FindFirstChildOfClass("TouchTransmitter") then
            for _, p in ipairs(char:GetDescendants()) do
                if p:IsA("BasePart") then
                    firetouchinterest(p, v, 0)
                    firetouchinterest(p, v, 1)
                end
            end
        end
    end
end

local LuckyNames = {
    LuckyBlock_Common = true,
    LuckyBlock_Rare = true,
    LuckyBlock_Epic = true
}

local function getHRP()
    return (lp.Character or lp.CharacterAdded:Wait()):WaitForChild("HumanoidRootPart")
end

local function pressE()
    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.E, false, game)
    task.wait(0.1)
    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.E, false, game)
end

local function collectLucky()
    for _, m in ipairs(workspace:GetDescendants()) do
        if m:IsA("Model") and LuckyNames[m.Name] then
            local part = m:FindFirstChildWhichIsA("BasePart", true)
            if part then
                getHRP().CFrame = part.CFrame * CFrame.new(0,0,-2)
                task.wait(0.25)
                pressE()
            end
        end
    end
end

-- ================= BUTTON WORKING =================
instantBtn.MouseButton1Click:Connect(function()
    task.spawn(runTouch)
end)

local autoTouch = false
autoTouchBtn.MouseButton1Click:Connect(function()
    autoTouch = not autoTouch
    autoTouchBtn.Text = autoTouch and "Auto Touch : ON" or "Auto Touch : OFF"

    task.spawn(function()
        while autoTouch do
            runTouch()
            task.wait(0.25)
        end
    end)
end)

local autoLucky = false
luckyBtn.MouseButton1Click:Connect(function()
    autoLucky = not autoLucky
    luckyBtn.Text = autoLucky and "Auto Lucky Block : ON" or "Auto Lucky Block : OFF"

    task.spawn(function()
        while autoLucky do
            collectLucky()
            task.wait(1)
        end
    end)
end)

-- ================= MINIMIZE =================
local minimized = false
minBtn.MouseButton1Click:Connect(function()
    minimized = not minimized
    content.Visible = not minimized
    main.Size = minimized and MIN_SIZE or FULL_SIZE
    minBtn.Text = minimized and "+" or "‚Äì"
end)

-- ================= DRAG (DELTA OK) =================
local dragging, dragStart, startPos

titleBar.InputBegan:Connect(function(i)
    if i.UserInputType == Enum.UserInputType.MouseButton1
    or i.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        dragStart = i.Position
        startPos = main.Position
    end
end)

UIS.InputChanged:Connect(function(i)
    if dragging and (i.UserInputType == Enum.UserInputType.MouseMovement
    or i.UserInputType == Enum.UserInputType.Touch) then
        local delta = i.Position - dragStart
        main.Position = UDim2.new(
            startPos.X.Scale,
            startPos.X.Offset + delta.X,
            startPos.Y.Scale,
            startPos.Y.Offset + delta.Y
        )
    end
end)

UIS.InputEnded:Connect(function(i)
    if i.UserInputType == Enum.UserInputType.MouseButton1
    or i.UserInputType == Enum.UserInputType.Touch then
        dragging = false
    end
end)
