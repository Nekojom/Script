-- ================= BOOST FPS =================
local BoostFPS = false
local Lighting = game:GetService("Lighting")

local defaultLighting = {
	GlobalShadows = Lighting.GlobalShadows,
	Brightness = Lighting.Brightness,
	FogEnd = Lighting.FogEnd,
	EnvironmentDiffuseScale = Lighting.EnvironmentDiffuseScale,
	EnvironmentSpecularScale = Lighting.EnvironmentSpecularScale
}

local function enableBoostFPS()
	pcall(function()
		settings().Rendering.QualityLevel = Enum.QualityLevel.Level01
		Lighting.GlobalShadows = false
		Lighting.Brightness = 1
		Lighting.FogEnd = 1e9
		Lighting.EnvironmentDiffuseScale = 0
		Lighting.EnvironmentSpecularScale = 0

		local Terrain = workspace:FindFirstChildOfClass("Terrain")
		if Terrain then
			Terrain.WaterWaveSize = 0
			Terrain.WaterWaveSpeed = 0
			Terrain.WaterReflectance = 0
			Terrain.WaterTransparency = 1
		end

		for _,v in ipairs(workspace:GetDescendants()) do
			if v:IsA("BasePart") then
				v.Material = Enum.Material.Plastic
				v.CastShadow = false
			elseif v:IsA("ParticleEmitter")
			or v:IsA("Trail")
			or v:IsA("Smoke")
			or v:IsA("Fire")
			or v:IsA("Sparkles") then
				v.Enabled = false
			end
		end
	end)
end

local function disableBoostFPS()
	pcall(function()
		settings().Rendering.QualityLevel = Enum.QualityLevel.Automatic
		for i,v in pairs(defaultLighting) do
			Lighting[i] = v
		end
	end)
end

-- ================= SERVICES =================
local Players = game:GetService("Players")
local player = Players.LocalPlayer
local char = player.Character or player.CharacterAdded:Wait()
local humanoid = char:WaitForChild("Humanoid")
local hrp = char:WaitForChild("HumanoidRootPart")

-- ================= SETTINGS =================
_G.AutoPopBox = false
local OPEN_DISTANCE = 7
local SCAN_INTERVAL = 3      -- สแกนช้าลง ลดกระตุก
local OPEN_DELAY = 0.5

local opened = {}
local boxCache = {}
local lastScan = 0
local busy = false

-- ================= UI =================
local gui = Instance.new("ScreenGui", game.CoreGui)
gui.Name = "AutoPopBoxUI"

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.new(0,220,0,150)
frame.Position = UDim2.new(0.05,0,0.4,0)
frame.BackgroundColor3 = Color3.fromRGB(30,30,30)
frame.Active = true
frame.Draggable = true

local autoBtn = Instance.new("TextButton", frame)
autoBtn.Size = UDim2.new(1,-20,0,45)
autoBtn.Position = UDim2.new(0,10,0,15)
autoBtn.Text = "AUTO : OFF"
autoBtn.TextSize = 18
autoBtn.TextColor3 = Color3.new(1,1,1)
autoBtn.BackgroundColor3 = Color3.fromRGB(170,0,0)

local boostBtn = Instance.new("TextButton", frame)
boostBtn.Size = UDim2.new(1,-20,0,35)
boostBtn.Position = UDim2.new(0,10,0,70)
boostBtn.Text = "BOOST FPS : OFF"
boostBtn.TextSize = 15
boostBtn.TextColor3 = Color3.new(1,1,1)
boostBtn.BackgroundColor3 = Color3.fromRGB(80,80,80)

autoBtn.MouseButton1Click:Connect(function()
	_G.AutoPopBox = not _G.AutoPopBox
	autoBtn.Text = _G.AutoPopBox and "AUTO : ON" or "AUTO : OFF"
	autoBtn.BackgroundColor3 = _G.AutoPopBox
		and Color3.fromRGB(0,170,0)
		or Color3.fromRGB(170,0,0)
end)

boostBtn.MouseButton1Click:Connect(function()
	BoostFPS = not BoostFPS
	boostBtn.Text = BoostFPS and "BOOST FPS : ON" or "BOOST FPS : OFF"
	boostBtn.BackgroundColor3 = BoostFPS
		and Color3.fromRGB(0,120,200)
		or Color3.fromRGB(80,80,80)

	if BoostFPS then
		enableBoostFPS()
	else
		disableBoostFPS()
	end
end)

-- ================= SCAN BOX (OPTIMIZED) =================
local function scanBoxes()
	table.clear(boxCache)
	for _,v in ipairs(workspace:GetDescendants()) do
		if (v:IsA("ProximityPrompt") or v:IsA("ClickDetector")) and not opened[v] then
			local p = v.Parent:IsA("Model") and v.Parent.PrimaryPart or v.Parent
			if p and p:IsA("BasePart") then
				table.insert(boxCache, v)
			end
		end
	end
end

local function getNearestBox()
	local closest, dist = nil, math.huge
	for _,box in ipairs(boxCache) do
		if box.Parent then
			local p = box.Parent:IsA("Model") and box.Parent.PrimaryPart or box.Parent
			if p then
				local d = (hrp.Position - p.Position).Magnitude
				if d < dist then
					dist = d
					closest = box
				end
			end
		end
	end
	return closest
end

local function openBox(box)
	if box:IsA("ProximityPrompt") then
		fireproximityprompt(box)
	elseif box:IsA("ClickDetector") then
		fireclickdetector(box)
	end
end

-- ================= MAIN LOOP (NO STUTTER) =================
task.spawn(function()
	while task.wait(0.5) do
		if not _G.AutoPopBox or busy then continue end

		if tick() - lastScan > SCAN_INTERVAL then
			lastScan = tick()
			scanBoxes()
		end

		local box = getNearestBox()
		if not box then
			table.clear(opened)
			task.wait(1)
			continue
		end

		local part = box.Parent:IsA("Model")
			and box.Parent.PrimaryPart
			or box.Parent

		if not part then
			opened[box] = true
			continue
		end

		busy = true
		humanoid:MoveTo(part.Position)

		task.delay(0.6, function()
			if (hrp.Position - part.Position).Magnitude <= OPEN_DISTANCE then
				openBox(box)
				opened[box] = true
			end
			busy = false
		end)
	end
end)
