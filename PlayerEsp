-- PlayerEsp.lua (แก้ไขสำหรับ Toggle)
_G.FriendColor = Color3.fromRGB(0, 0, 255)
_G.EnemyColor = Color3.fromRGB(255, 0, 0)
_G.UseTeamColor = true

if not getgenv then getgenv = _G end
getgenv().PlayerEspEnabled = getgenv().PlayerEspEnabled or false

--------------------------------------------------------------------
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local plr = Players.LocalPlayer

-- โฟลเดอร์หลักเก็บ ESP
local Holder = game.CoreGui:FindFirstChild("ESP") or Instance.new("Folder", game.CoreGui)
Holder.Name = "ESP"

-- ฟังก์ชันสร้าง Highlight
local function esp(target, color)
    if not getgenv().PlayerEspEnabled then return end
    if target.Character then
        if not target.Character:FindFirstChild("GetReal") then
            local highlight = Instance.new("Highlight")
            highlight.Name = "GetReal"
            highlight.Adornee = target.Character
            highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
            highlight.FillColor = color
            highlight.Parent = target.Character
        else
            target.Character.GetReal.FillColor = color
        end
    end
end

-- ฟังก์ชันลบ ESP ทั้งหมด
local function clearAllEsp()
    for _, v in pairs(Players:GetPlayers()) do
        if v.Character and v.Character:FindFirstChild("GetReal") then
            v.Character.GetReal:Destroy()
        end
    end
    if Holder then
        Holder:ClearAllChildren()
    end
end

-- ลูปหลัก
spawn(function()
    while task.wait(0.2) do
        if not getgenv().PlayerEspEnabled then
            clearAllEsp()
            -- รอจนกว่าจะเปิดใช้งานใหม่
            repeat task.wait(1) until getgenv().PlayerEspEnabled
        end

        -- วนสร้าง ESP ให้ผู้เล่นทุกคน
        for _, v in pairs(Players:GetPlayers()) do
            if v ~= plr then
                local color = _G.UseTeamColor and v.TeamColor.Color or ((plr.TeamColor == v.TeamColor) and _G.FriendColor or _G.EnemyColor)
                esp(v, color)
            end
        end
    end
end)
